---
title: å…³äºå¦‚ä½•å†™ä¸€ä¸ªç²¾ç¡®çš„å€’è®¡æ—¶
description: æ¢è®¨å¦‚ä½•å®ç°é«˜æ€§èƒ½ã€ç¨³å®šä¸”å‡†ç¡®çš„å€’è®¡æ—¶å™¨ï¼Œæä¾›æœ€ä½³å®è·µå’Œä»£ç ç¤ºä¾‹ï¼Œç¡®ä¿å€’è®¡æ—¶çš„ç²¾ç¡®æ€§å’Œæ•ˆç‡ã€‚
date: "2024-03-09"
---

åˆåˆ°äº†é‡‘ä¸‰é“¶å››çš„å­£èŠ‚äº†ï¼Œé¢è¯•çš„å„ä½åŒå­¦è¦å¼€å§‹å‡†å¤‡èµ·æ¥äº†ï¼Œä»Šå¤©ä¸»è¦åˆ†äº«ä¸€ä¸ªåœ¨é¢è¯•ä¸­ç»å¸¸è¢«æåˆ°çš„ä¸€ä¸ªé¢è¯•é¢˜ï¼šå€’è®¡æ—¶ã€‚å…¶å®è¿™ä¸ªé—®é¢˜ä¸ä»…æ˜¯åœ¨é¢è¯•ä¸­ï¼Œä¹Ÿåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡é‡Œä¹Ÿä¼šç»å¸¸ç”¨åˆ°ï¼Œæ‰€ä»¥åˆ°åº•å¦‚ä½•æ‰èƒ½å†™å¥½ä¸€ä¸ªå€’è®¡æ—¶å‘¢ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬åœ¨å†™å€’è®¡æ—¶çš„æ—¶å€™å¿…é¡»è¦è€ƒè™‘åˆ°ä¸‰ç‚¹ï¼š**å‡†ç¡®æ€§ã€æ€§èƒ½**ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€æ­¥ä¸€æ­¥å®ç°ä¸€ä¸ªå‡†ç¡®çš„å®šæ—¶å™¨ã€‚

## setIntervalï¼š

æˆ‘ä»¬å…ˆæ¥ç®€å•å®ç°ä¸€ä¸ªå€’è®¡æ—¶çš„å‡½æ•°ï¼š

```jsx
function example1(leftTime) {
	let t = leftTime;
	setInterval(() => {
		t = t - 1000;
		console.log(t);
	}, 1000);
}

example1(10);
```

å¯ä»¥çœ‹åˆ°ä½¿ç”¨ setInterval å³å¯ï¼Œä½†æ˜¯ setInterval çœŸçš„å‡†ç¡®å—ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ MDN ä¸­çš„è¯´æ˜ï¼š

<aside>
	ğŸ’¡
	å¦‚æœä½ çš„ä»£ç é€»è¾‘æ‰§è¡Œæ—¶é—´å¯èƒ½æ¯”å®šæ—¶å™¨æ—¶é—´é—´éš”è¦é•¿ï¼Œå»ºè®®ä½ ä½¿ç”¨é€’å½’è°ƒç”¨äº†Â [setTimeout()](https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout)Â çš„å…·åå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨Â setInterval()Â ä»¥
	5
	ç§’çš„é—´éš”è½®è¯¢æœåŠ¡å™¨ï¼Œå¯èƒ½å› ç½‘ç»œå»¶è¿Ÿã€æœåŠ¡å™¨æ— å“åº”ä»¥åŠè®¸å¤šå…¶ä»–çš„é—®é¢˜è€Œå¯¼è‡´è¯·æ±‚æ— æ³•åœ¨åˆ†é…çš„æ—¶é—´å†…å®Œæˆã€‚
</aside>

ç®€å•æ¥è¯´æ„æ€å°±æ˜¯ï¼Œjs å› ä¸ºæ˜¯å•çº¿ç¨‹çš„åŸå› ï¼Œå¦‚æœå‰é¢æœ‰é˜»å¡çº¿ç¨‹çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±å¯èƒ½ä¼šå¯¼è‡´ setInterval å‡½æ•°å»¶è¿Ÿï¼Œè¿™æ ·å€’è®¡æ—¶å°±è‚¯å®šä¼šä¸å‡†ç¡®ï¼Œå»ºè®®ä½¿ç”¨ setTimeout æ›¿æ¢ setIntervalã€‚

## setTimeoutï¼š

æŒ‰ç…§ä¸Šè¿°çš„å»ºè®®å°† setInterval æ¢ä¸º setTimeout åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä»£ç ï¼š

```jsx
function example2(leftTime) {
	let t = leftTime;
	setTimeout(() => {
		t = t - 1000;
		if (t > 0) {
			console.log(t);
			example2(t);
		}
		console.log(t);
	}, 1000);
}
```

MDN ä¸­ä¹Ÿè¯´äº†ï¼Œæœ‰å¾ˆå¤šå› ç´ ä¼šå¯¼è‡´ setTimeout çš„å›è°ƒå‡½æ•°æ‰§è¡Œæ¯”è®¾å®šçš„é¢„æœŸå€¼æ›´ä¹…ï¼Œæ¯”å¦‚**åµŒå¥—è¶…æ—¶ã€éæ´»åŠ¨æ ‡ç­¾è¶…æ—¶ã€è¿½è¸ªå‹è„šæœ¬çš„èŠ‚æµã€è¶…æ—¶å»¶è¿Ÿ**ç­‰ç­‰ï¼Œè¯¦æƒ…è§[https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout](https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout)ï¼Œæ€»å°±å°±æ˜¯å’Œ setInterval å·®ä¸å¤šï¼Œæ—¶é—´ä¸€é•¿ï¼Œå°±ä¼šæœ‰è¯¯å·®å‡ºç°ï¼Œè€Œä¸” setTimeout æœ‰ä¸€ä¸ªå¾ˆä¸å¥½çš„ç‚¹åœ¨äºï¼Œå½“ä½ çš„ç¨‹åºåœ¨åå°è¿è¡Œæ—¶ï¼ŒsetTimeout ä¹Ÿä¼šä¸€ç›´æ‰§è¡Œï¼Œè¿™æ ·ä¼šä¸¥é‡çš„è€Œæµªè´¹æ€§èƒ½ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™ç§é—®é¢˜å—ï¼Ÿ

## requestAnimationFrame

è¿™é‡Œå°±ä¸å¾—ä¸æä¸€ä¸ªæ–°çš„æ–¹æ³• requestAnimationFrameï¼Œå®ƒæ˜¯ä¸€ä¸ªæµè§ˆå™¨ APIï¼Œå…è®¸ä»¥ 60 å¸§/ç§’ (FPS) çš„é€Ÿç‡è¯·æ±‚å›è°ƒï¼Œè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚é€šè¿‡è°ƒç”¨ requestAnimationFrame æ–¹æ³•æµè§ˆå™¨ä¼šåœ¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å›è°ƒåœ¨æ¯ä¸€å¸§ä¹‹é—´éƒ½èƒ½å¤Ÿå¾—åˆ°é€‚æ—¶çš„æ›´æ–°ã€‚

æˆ‘ä»¬ä½¿ç”¨ requestAnimationFrame ç»“åˆ setTimeout æ¥ä¼˜åŒ–ä¸€ä¸‹ä¹‹å‰çš„ä»£ç ï¼š

```jsx
function example4(leftTime) {
	let t = leftTime;
	function start() {
		requestAnimationFrame(() => {
			t = t - 1000;
			setTimeout(() => {
				console.log(t);
				start();
			}, 1000);
		});
	}
	start();
}
```

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ requestAnimationFrame + setTimeout å‘¢ï¼Ÿ ä¸€ä¸ªæ˜¯æ¯å±æˆ–è€…åˆ‡åå°çš„æ“ä½œæ—¶ï¼ŒrequestAnimationFrame æ˜¯ä¸ä¼šç»§ç»­è°ƒç”¨å‡½æ•°çš„ï¼Œä½†æ˜¯å¦‚æœåªä½¿ç”¨ requestAnimationFrame çš„è¯ï¼Œå‡½æ•°ç›¸å½“äº 1 ç§’çš„æ—¶å€™è¦è°ƒç”¨ 60 æ¬¡ï¼Œå¤ªæµªè´¹æ€§èƒ½ã€‚

åœ¨åˆ‡åå°æˆ–è€…æ¯å±çš„å®é™…æ‰§è¡Œæ—¶ä¼šå‘ç°ï¼Œå½“å›åˆ°é¡µé¢æ—¶ï¼Œå€’è®¡æ—¶ä¼šæ¥ç€åˆ‡åå°æ—¶çš„æ—¶é—´æ‰§è¡Œï¼Œè€Œæ²¡æœ‰æ›´æ–°åˆ°æœ€æ–°çš„æ—¶é—´ï¼Œè¿™æ ·çš„ bug æ˜¯æ¥å—ä¸äº†çš„ã€‚

## diffTime å·®å€¼è®¡ç®—ï¼š

è¦è§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œæœ€é€šç”¨çš„åŠæ³•å°±æ˜¯é€šè¿‡æ—¶é—´å·®å€¼æ¯æ¬¡è¿›è¡Œå¯¹æ¯”å°±å¯ä»¥äº†ã€‚

```jsx
function example5(leftTime) {
	const now = performace.now();
	function start() {
		setTimeout(() => {
			const diff = leftTime - (performace.now() - now);
			console.log(diff);
			requestAnimationFrame(start);
		}, 1000);
	}
	start();
}
```

ä¸Šé¢çš„ä»£ç å®ç°æ€è·¯å…¶å®åœ¨å®é™…çš„ä¸šåŠ¡ä¸­å·²ç»èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯ï¼Œä½†å…¶å®è¿˜æ˜¯æ²¡æœ‰è§£å†³ setTimeout ä¼šå»¶è¿Ÿçš„é—®é¢˜ï¼Œå½“çº¿ç¨‹è¢«å ç”¨ä¹‹åï¼Œå¾ˆå®¹æ˜“å‡ºç°è¯¯å·®ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆæ›´æ–°çš„åŠæ³•è¿›è¡Œå¤„ç†å‘¢ï¼Ÿ

## æœ€ä½³æ–¹æ¡ˆ

å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼ŒsetTimeout å‡½æ•°ä¸­æ‰§è¡Œä»£ç çš„æ—¶é—´è‚¯å®šæ˜¯è¦å¤§äºç­‰äº setTimeout æ—¶é—´çš„ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°è®¾å®šçš„ 1 ç§’ï¼Œå®é™…æ‰§è¡Œå´æ‰§è¡Œäº† 2 ç§’çš„æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å®ç°æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œæ¯æ¬¡è®¡ç®—ä¸€ä¸‹ setTimeout å®é™…æ‰§è¡Œçš„æ—¶é—´ï¼Œç„¶ååŠ¨æ€çš„è°ƒæ•´ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶é—´ï¼Œè€Œä¸æ˜¯è®¾ç½®å›ºå®šçš„å€¼

æˆ‘ä»¬æ¥ç”¨å›¾è¡¨ä¸¾ä¾‹æ¨æ¼”ä¸€ä¸‹æ¯æ¬¡æ‰§è¡Œçš„æƒ…å†µï¼š

| ç¬¬ n æ¬¡æ‰§è¡Œ | executionTime å®é™…æ‰§è¡Œæ—¶é—´ | nextTime ä¸‹æ¬¡éœ€è¦æ‰§è¡Œçš„æ—¶é—´ | totleTime æ‰§è¡Œçš„æ€»æ—¶é—´ |
| ----------- | -------------------------- | --------------------------- | ---------------------- |
| 0           | 0                          | 1000                        | 0                      |
| 1           | 1200                       | 800                         | 1200                   |
| 2           | 1100                       | 700                         | 2300                   |
| 3           | 1000                       | 700                         | 3300                   |
| 4           | 2200                       | 500                         | 5500                   |
| 5           | 1300                       | 200                         | 6800                   |
| 6           | 1200                       | 1000                        | 8000                   |
| â€¦           | â€¦                          | â€¦                           | â€¦                      |

ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼šä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ nextTime = 1000 - totleTime % 1000ï¼›è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ï¼Œä»è€Œæ¯æ¬¡éƒ½å»åŠ¨æ€çš„è°ƒæ•´å¤šä½™æ¶ˆè€—çš„æ—¶é—´ï¼Œå¤§å¤§å‡å°å€’è®¡æ—¶æœ€ç»ˆçš„è¯¯å·®

è¿˜æœ‰éœ€è¦è€ƒè™‘çš„æ˜¯ï¼Œå®é™…ä¸šåŠ¡ä¸­è¿”å›çš„å‰©ä½™æ—¶é—´è‚¯å®šä¸ä¼šæ˜¯æ•´æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶é—´æœ€å¥½å¯ä»¥å…ˆè®©å‰©ä½™æ—¶é—´å˜ä¸ºæ•´æ•°ï¼Œè¿™æ ·å¯ä»¥åœ¨å€’è®¡æ—¶åˆ°æœ€åä¸€ç§’æ—¶æ›´åŠ çš„ç²¾ç¡®ã€‚

æ ¹æ®ä¸Šè¿°çš„æ€è·¯æ¥çœ‹ä¸€ä¸‹æœ€ç»ˆå°è£…å‡ºæ¥çš„ react hooksï¼š

```jsx
const useCountDown = ({ leftTime, ms = 1000, onEnd }: CountDownProps) => {
	const countdownTimer = useRef<NodeJS.Timeout | null>();

	const startTimeRef = useRef<number>(performance.now());

	const nextTimeRef = useRef<number>(leftTime % ms);

	const totalTimeRef = useRef<number>(0);

	const [count, setCount] = useState(leftTime);

	const preLeftTime = usePrevious(leftTime);

	const clearTimer = useCallback(() => {
		if (countdownTimer.current) {
			clearTimeout(countdownTimer.current);

			countdownTimer.current = null;
		}
	}, []);

	// requestAnimationFrame

	const startCountDown = useCallback(
		(nt: number = 0) => {
			clearTimer();

			// æ¯æ¬¡å®é™…æ‰§è¡Œçš„æ—¶é—´

			const executionTime = performance.now() - startTimeRef.current; // 1.x

			totalTimeRef.current = totalTimeRef.current + executionTime;

			// å‰©ä½™æ—¶é—´å‡å»åº”è¯¥æ‰§è¡Œçš„æ—¶é—´

			setCount((count) => {
				const nextCount =
					count - (Math.floor(executionTime / ms) || 1) * ms - nt;

				return nextCount <= 0 ? 0 : nextCount;
			});

			// ç®—å‡ºä¸‹ä¸€æ¬¡çš„æ—¶é—´

			nextTimeRef.current = ms - (totalTimeRef.current % ms);

			// é‡ç½®åˆå§‹æ—¶é—´

			startTimeRef.current = performance.now();

			countdownTimer.current = setTimeout(() => {
				requestAnimationFrame(() => startCountDown(0));
			}, nextTimeRef.current);
		},

		[ms]
	);

	useEffect(() => {
		if (preLeftTime !== leftTime && preLeftTime !== undefined) {
			clearTimer();

			setCount(() => leftTime);

			nextTimeRef.current = leftTime % ms;

			countdownTimer.current = setTimeout(() => {
				requestAnimationFrame(() =>
					startCountDown(nextTimeRef.current)
				);
			}, nextTimeRef.current);
		}
	}, [leftTime, ms]);

	useEffect(() => {
		countdownTimer.current = setTimeout(
			() => startCountDown(nextTimeRef.current),

			nextTimeRef.current
		);

		return () => {
			clearTimer();
		};
	}, []);

	useEffect(() => {
		if (count <= 0) {
			clearTimer();

			onEnd && onEnd();
		}
	}, [count]);

	const formatCount = parseMillisecond(count);

	return { formatCount, count };
};

export default useCountDown;
```

å¦‚æœæƒ³è¦å°è£…ç»„ä»¶çš„è¯ï¼Œå¯ä»¥åœ¨ hooks çš„åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å°è£…ã€‚

åˆ°è¿™é‡Œï¼Œè‚¯å®šä¼šæœ‰äººè¯´ï¼Œåšäº†è¿™ä¹ˆå¤šçš„æ“ä½œï¼Œæœ‰å¿…è¦å—ï¼Œå°±ç®—å·® 0 ç‚¹å‡ ç§’ï¼Œåœ¨å®é™…ä½“éªŒä¸­ç”¨æˆ·å®Œå…¨æ„Ÿå—ä¸å‡ºæ¥ã€‚æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå®Œç¾æ¯”å®Œæˆæ›´é‡è¦ï¼Œç§¯ç´¯æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œå¾ˆå¤šæ²¡æœ‰å¿…è¦çš„ä¸œè¥¿å¦‚æœä½ èƒ½è¿›è¡Œäº†è§£ç ”ç©¶ï¼Œä»ä¸­å­¦åˆ°ä¸€äº›è§£é¢˜çš„æ€è·¯æˆ–è€…æ–¹æ³•ï¼Œè¿™æ‰æ˜¯å¯¹æˆ‘ä»¬æœ€æœ‰æ„ä¹‰çš„ã€‚
